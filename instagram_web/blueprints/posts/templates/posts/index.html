{% extends '_layout.html' %}

{% block title %}
All Posts
{% endblock %}

{% block content %}

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="alert alert-secondary mb-0" role="alert">
    {% for message in messages %}
    <span>{{ message }}</span>
    {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% if posts %}

<div class="">
    <nav class="d-flex justify-content-center pt-4" aria-label="Page navigation">
        <ul class="pagination mx-auto">
          <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link text-light {% if page == 1 %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page=1" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>

          {% if pages <= 5 %}
            {% for x in range(1, pages+1) %}
              <li class="page-item {% if page == x %}disabled{% endif %}">
                <a class="page-link text-light {% if page == x %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page={{x}}">{{x}}</a>
              </li>
            {% endfor %}
          {% else %}
            {% if (page-2) < 1 %}
              {% for x in range(1, 6) %}
                <li class="page-item {% if page == x %}disabled{% endif %}">
                  <a class="page-link text-light {% if page == x %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page={{x}}">{{x}}</a>
                </li>
              {% endfor %}
            {% elif (page+2) > pages %}
              {% for x in range((pages-4), (pages+1)) %}
                <li class="page-item {% if page == x %}disabled{% endif %}">
                  <a class="page-link text-light {% if page == x %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page={{x}}">{{x}}</a>
                </li>
              {% endfor %}
            {% else %}
              {% for x in range((page-2), (page+3)) %}
                <li class="page-item {% if page == x %}disabled{% endif %}">
                  <a class="page-link text-light {% if page == x %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page={{x}}">{{x}}</a>
                </li>
              {% endfor %}
            {% endif %}
          {% endif %}


          <li class="page-item {% if page == pages %}disabled{% endif %}">
            <a class="page-link text-light {% if page == pages %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page={{pages}}" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
    </nav>
    </div>

{% endif %}

<div class="container-fluid">
  <div class="row">

    {% for post in posts %}


    <!-- ••• -->

        <div class="col-11 col-sm-7 col-md-6 col-lg-5 col-xl-5 post_container">
          <div class="post_user_group">
            <img class="post_avatar" src="{{ post.user.avatar_url }}">
            <a class="post_user text-decoration-none" href="{{ url_for('users.show', username=post.user.username) }}">{{ post.user.username }}</a>
            <div class="dropdown ml-auto">
              <button class="post_options_button" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-cog"></i>
              </button>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="{{ url_for('posts.show', post_id=post.image) }}"><i class="fas fa-external-link-alt"></i> Permalink</a>                
                <!-- <a class="dropdown-item" href="#"><i class="far fa-money-bill-alt"></i> Tip Post</a> -->
                {% if post.user_id != current_user.id %}
                <div class="dropdown-divider"></div>
                <form action="{{ url_for('users.unfollow', id=post.user_id) }}" method="POST">
                  <input type="hidden" name="next" value="{{ url_for('posts.index') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <button type="submit" class="dropdown-item" href="#"><i class="fas fa-user-slash"></i> Unfollow {{ post.user.username }}</button>
                </form>
                {% endif %}
              </div>
            </div>
          </div>
          <img class="post_image" src="{{ post.image_url }}">
          <div class="post_comment_group">

            <div class="icons_group">
              {% if current_user.is_authenticated and post.is_liked(current_user) %}
                <form class="like_buttons_form" action="{{ url_for('posts.unlike', post=post.id) }}" method="POST">
                  <button class="button_unlike" type="Submit"><i class="fas fa-heart"></i></button>
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                </form>
              {% else %}
                <form class="like_buttons_form" action="{{ url_for('posts.like', post=post.id) }}" method="POST">
                  <button class="button_like" type="Submit"><i class="far fa-heart"></i></button>
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                </form>
              {% endif %}
              {% if post.likes|length %}
                {% if current_user.is_authenticated %}
                  {% if post.is_liked(current_user) %}
                    {% if post.likes|length > 1 %}
                      <span>You and {{ post.likes|length-1 }} other coder{% if post.likes|length > 2 %}s{% endif %} like this.</span>
                    {% else %}
                      <span>You like this.</span>
                    {% endif %}
                  {% else %}
                    <span>Liked by {{ post.likes|length }} coder{% if post.likes|length > 1 %}s{% endif %}.</span>
                  {% endif %}
                {% else %}
                  <span>Liked by {{ post.likes|length }} coder{% if post.likes|length > 1 %}s{% endif %}.</span>
                {% endif %}
              {% else %}
                <span>Be the first coder to like this post!</span>
              {% endif %}
            </div>

            <a class="post_user_caption text-decoration-none" href="{{ url_for('users.show', username=post.user.username) }}">{{ post.user.username }}</a>
            <span class="post_caption">{{ post.caption }}</span>
            <h6 class="post_when">{{ post.when }}</h6>

          </div>
        </div>
        <div class="w-100 my-3"></div>
    
    {% endfor %}

  </div>
</div>

{% if posts %}

<div class="">
    <nav class="d-flex justify-content-center pb-4" aria-label="Page navigation">
        <ul class="pagination mx-auto">
          <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link text-light {% if page == 1 %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page=1" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>

          {% if pages <= 5 %}
            {% for x in range(1, pages+1) %}
              <li class="page-item {% if page == x %}disabled{% endif %}">
                <a class="page-link text-light {% if page == x %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page={{x}}">{{x}}</a>
              </li>
            {% endfor %}
          {% else %}
            {% if (page-2) < 1 %}
              {% for x in range(1, 6) %}
                <li class="page-item {% if page == x %}disabled{% endif %}">
                  <a class="page-link text-light {% if page == x %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page={{x}}">{{x}}</a>
                </li>
              {% endfor %}
            {% elif (page+2) > pages %}
              {% for x in range((pages-4), (pages+1)) %}
                <li class="page-item {% if page == x %}disabled{% endif %}">
                  <a class="page-link text-light {% if page == x %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page={{x}}">{{x}}</a>
                </li>
              {% endfor %}
            {% else %}
              {% for x in range((page-2), (page+3)) %}
                <li class="page-item {% if page == x %}disabled{% endif %}">
                  <a class="page-link text-light {% if page == x %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page={{x}}">{{x}}</a>
                </li>
              {% endfor %}
            {% endif %}
          {% endif %}


          <li class="page-item {% if page == pages %}disabled{% endif %}">
            <a class="page-link text-light {% if page == pages %}bg-secondary{% else %}bg-dark{% endif %}" href="{{ url_for('posts.index') }}?page={{pages}}" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
    </nav>
    </div>

{% endif %}

{% endblock %}